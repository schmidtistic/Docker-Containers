services:
  frigate:
    container_name: frigate
    image: ghcr.io/blakeblackshear/frigate:stable-tensorrt
    restart: unless-stopped
    entrypoint: /init

    # Match Unraid GUI behavior
    network_mode: bridge
    gpus: all

    # Environment
    env_file:
      - /mnt/user/ComputerSyncs/MacBook Backup/Configuration/Github/Docker-Containers/.env

    environment:
      TZ: ${TZ}

      # Frigate / go2rtc
      FRIGATE_RTSP_PASSWORD: ${FRIGATE_RTSP_PASSWORD}

      # NVIDIA
      NVIDIA_VISIBLE_DEVICES: ${NVIDIA_VISIBLE_DEVICES}
      NVIDIA_DRIVER_CAPABILITIES: ${NVIDIA_DRIVER_CAPABILITIES}

      # Runtime tuning
      TOKENIZERS_PARALLELISM: "true"
      TRANSFORMERS_NO_ADVISORY_WARNINGS: "1"

    # Ports
    ports:
      - "5000:5000"        # UI / API
      - "8554:8554"        # RTSP
      - "8555:8555/tcp"    # WebRTC (TCP)
      - "8555:8555/udp"    # WebRTC (UDP)

    # Volumes
    volumes:
      - ${FRIGATE_CONFIG_PATH}:/config
      - ${FRIGATE_MEDIA_PATH}:/media/frigate
      - /etc/localtime:/etc/localtime:ro
      - /tmp/cache:/tmp/cache

    # Devices
    devices:
      - /dev/bus/usb:/dev/bus/usb   # USB Coral

    shm_size: "64mb"

    healthcheck:
      test: ["CMD", "curl", "-fs", "http://localhost:5000"]
      interval: 30s
      timeout: 10s
      retries: 5
